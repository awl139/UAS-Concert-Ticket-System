name: CI/CD Pipeline for Concert Ticket System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Test User Service
  test-user-service:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # ← TAMBAH INI
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Dependencies (User Service)
      working-directory: ./user-service
      run: npm ci
    
    - name: Run Tests (User Service)
      working-directory: ./user-service
      run: npm test -- --passWithNoTests

  # Test Order Service
  test-order-service:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # ← TAMBAH INI
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Dependencies (Order Service)
      working-directory: ./order-service
      run: npm ci
    
    - name: Run Tests (Order Service)
      working-directory: ./order-service
      run: npm test -- --passWithNoTests

  # Test Frontend
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # ← TAMBAH INI
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Dependencies (Frontend)
      working-directory: ./frontend
      run: |
        if [ -f "package.json" ]; then
          npm ci
        else
          echo "No package.json, skipping npm install"
        fi
    
    - name: Run Tests (Frontend)
      working-directory: ./frontend
      run: |
        if [ -f "package.json" ]; then
          npm test -- --passWithNoTests
        else
          echo "No package.json, skipping tests"
          exit 0
        fi

  # Build Docker Images (Simplified)
  build:
    needs: [test-user-service, test-order-service, test-frontend]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Build with Docker Compose
      run: docker-compose build
