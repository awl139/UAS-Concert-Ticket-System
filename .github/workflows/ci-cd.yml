name: CI/CD Pipeline for Concert Ticket System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Test User Service
  test-user-service:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: user-service/package-lock.json
    
    - name: Install Dependencies (User Service)
      working-directory: ./user-service
      run: npm ci
    
    - name: Run Tests (User Service)
      working-directory: ./user-service
      run: npm test -- --passWithNoTests  # ← FIXED
    
    - name: Build User Service
      working-directory: ./user-service
      run: npm run build

  # Test Order Service
  test-order-service:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: order-service/package-lock.json
    
    - name: Install Dependencies (Order Service)
      working-directory: ./order-service
      run: npm ci
    
    - name: Run Tests (Order Service)
      working-directory: ./order-service
      run: npm test -- --passWithNoTests  # ← FIXED
    
    - name: Build Order Service
      working-directory: ./order-service
      run: npm run build

  # Test Frontend
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Check if frontend has package.json
      id: check_package
      run: |
        if [ -f "frontend/package.json" ]; then
          echo "has_package=true" >> $GITHUB_OUTPUT
        else
          echo "has_package=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Install NPM Dependencies (if exists)
      if: steps.check_package.outputs.has_package == 'true'
      working-directory: ./frontend
      run: npm ci
    
    - name: Run Frontend Tests (if exists)
      if: steps.check_package.outputs.has_package == 'true'
      working-directory: ./frontend
      run: npm test -- --passWithNoTests  # ← FIXED
    
    - name: Skip frontend tests (no package.json)
      if: steps.check_package.outputs.has_package == 'false'
      run: echo "No package.json in frontend, skipping tests"

  # Build and Push Docker Images (OPTIONAL - bisa di-skip)
  build-and-push:
    needs: [test-user-service, test-order-service, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker images
      run: docker-compose build

  # Deploy to Server (OPTIONAL - bisa di-skip)
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Skip deployment (no server config)
      run: echo "Deployment skipped - no server configuration"
